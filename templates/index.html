<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Intelligence Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #020a05 0%, #0f1a0f 45%, #1a3d1a 75%, #26562d 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .search-container {
            background: #1a1515;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 30px;
            border: 1px solid #3d2020;
        }

        .search-box {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-box input {
            flex: 1;
            padding: 15px 20px;
            font-size: 1.1em;
            border: 2px solid #3d2020;
            border-radius: 10px;
            transition: all 0.3s;
            background: #2d2020;
            color: #f0f0f0;
        }

        .search-box input::placeholder {
            color: #888;
        }

        .search-box input:focus {
            outline: none;
            border-color: #28846b;
            box-shadow: 0 0 0 3px rgba(40, 132, 107, 0.2);
            background: #253530;
        }

        .search-box button {
            padding: 15px 40px;
            font-size: 1.1em;
            background: linear-gradient(135deg, #1f4a2f 0%, #28846b 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 600;
        }

        .search-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 31, 31, 0.6);
        }

        .search-box button:active {
            transform: translateY(0);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 1.2em;
        }

        .results {
            display: none;
        }

        .card {
            background: #1a1515;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            border: 1px solid #3d2020;
        }

        .card h2 {
            color: #f0f0f0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #28846b;
            font-size: 1.8em;
        }

        .card h3 {
            color: #e0e0e0;
            margin-top: 20px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-item {
            background: #202d25;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #28846b;
        }

        .info-item label {
            display: block;
            color: #aaa;
            font-size: 0.9em;
            margin-bottom: 5px;
            font-weight: 600;
        }

        /* Make inline label spans inside info-item (used for volume stats) white */
        .info-item .label {
            display: block;
            color: #f0f0f0;
            font-size: 0.95em;
            margin-bottom: 6px;
            font-weight: 700;
        }

        .info-item .value {
            font-size: 1.3em;
            color: #f0f0f0;
            font-weight: bold;
        }

        .positive {
            color: #10b981 !important;
        }

        .negative {
            color: #ef4444 !important;
        }

        .metric-card {
            background: linear-gradient(135deg, #142d1a 0%, #1f4a2f 50%, #265635 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .metric-card .label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .metric-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .news-item {
            background: #2d2020;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #28846b;
            transition: transform 0.2s;
        }

        .news-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            background: #352525;
        }

        .news-item h4 {
            color: #f0f0f0;
            margin-bottom: 8px;
        }

        .news-item .meta {
            color: #999;
            font-size: 0.9em;
        }

        .news-item p {
            color: #ccc;
        }

        .news-item a {
            color: #ff9999;
            text-decoration: none;
            font-weight: 600;
        }

        .news-item a:hover {
            text-decoration: underline;
            color: #ffbbbb;
        }
        
        .tooltip-container {
            position: relative;
            display: inline-block;
            cursor: help;
            border-bottom: 1px dotted #666;
        }
        
        .tooltip-text {
            visibility: hidden;
            width: 300px;
            background-color: #2d2d2d;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9em;
            line-height: 1.5;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #2d2d2d transparent transparent transparent;
        }
        
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .profitability-status {
            background: #2d2020;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #10b981;
        }
        
        .profitability-status.unprofitable {
            border-left-color: #ef4444;
        }

        .profitability-status p {
            color: #ccc;
        }

        .profitability-status small {
            color: #999 !important;
        }

        .chart-container {
            margin-top: 20px;
            min-height: 400px;
        }

        .period-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 8px 20px;
            border: 2px solid #28846b;
            background: #202d25;
            color: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .period-btn:hover {
            background: #253d30;
            border-color: #38a085;
        }

        .period-btn.active {
            background: linear-gradient(135deg, #142d1a 0%, #1f4a2f 100%);
            color: white;
            border-color: #1f4a2f;
        }

        .financial-trend-chart {
            margin-top: 20px;
            min-height: 400px;
            width: 100%;
            max-width: 1400px;
        }

        .significant-move {
            background: #3d2a1a;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            color: #f0f0f0;
        }

        .comparison-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: 10px;
        }

        .badge-better {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-worse {
            background: #fee2e2;
            color: #991b1b;
        }

        .error {
            background: #1a3d2a;
            color: #ccffdd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #ef4444;
        }

        .reddit-item {
            background: #2d2020;
            border: 1px solid #3d2020;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            color: #f0f0f0;
        }

        .reddit-item .score {
            display: inline-block;
            background: #ff4500;
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .reddit-item a {
            color: #ff9999;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .search-box button {
                width: 100%;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìà Stock Intelligence Dashboard</h1>
            <p>Comprehensive stock analysis with real-time data, financials, and market sentiment</p>
        </div>

        <div class="search-container">
            <div class="search-box">
                <input type="text" id="tickerInput" placeholder="Enter stock ticker symbol (e.g., MU, AAPL, TSLA, MSFT)" />
                <button onclick="analyzeStock()">Analyze</button>
            </div>
            <div style="margin-top: 15px; color: #ddd; font-size: 0.9em;">
                <strong>üí° Tip:</strong> Enter the ticker symbol, not company name. 
                Examples: <span style="color: #ff9999; font-weight: 600;">MU</span> (Micron), 
                <span style="color: #ff9999; font-weight: 600;">AAPL</span> (Apple), 
                <span style="color: #ff9999; font-weight: 600;">NVDA</span> (NVIDIA), 
                <span style="color: #ff9999; font-weight: 600;">TSLA</span> (Tesla)
            </div>
        </div>

        <div class="loading" id="loading">
            <p>üîç Analyzing stock data... Please wait...</p>
        </div>

        <div class="results" id="results"></div>
    </div>

    <script>
        // Allow Enter key to trigger search
        document.getElementById('tickerInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeStock();
            }
        });

        function formatNumber(num) {
            if (num === 'N/A' || num === null || num === undefined) return 'N/A';
            if (typeof num === 'string') return num;
            
            if (Math.abs(num) >= 1e12) {
                return (num / 1e12).toFixed(2) + 'T';
            } else if (Math.abs(num) >= 1e9) {
                return (num / 1e9).toFixed(2) + 'B';
            } else if (Math.abs(num) >= 1e6) {
                return (num / 1e6).toFixed(2) + 'M';
            } else if (Math.abs(num) >= 1e3) {
                return (num / 1e3).toFixed(2) + 'K';
            }
            return num.toFixed(2);
        }

        function formatPercent(num) {
            if (num === 'N/A' || num === null || num === undefined) return 'N/A';
            if (typeof num === 'number') {
                return (num * 100).toFixed(2) + '%';
            }
            return num;
        }

        async function analyzeStock() {
            const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
            if (!ticker) {
                alert('Please enter a stock ticker');
                return;
            }

            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            
            loading.style.display = 'block';
            results.style.display = 'none';
            results.innerHTML = '';

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ticker: ticker })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch data');
                }

                displayResults(data);
                loading.style.display = 'none';
                results.style.display = 'block';

            } catch (error) {
                loading.style.display = 'none';
                results.innerHTML = `<div class="error"><strong>Error:</strong> ${error.message}</div>`;
                results.style.display = 'block';
            }
        }

        function displayResults(data) {
            const results = document.getElementById('results');
            const info = data.basic_info;
            const metrics = data.financial_metrics;
            const comparison = data.industry_comparison;
            const volumeData = data.volume_analysis;
            const news = data.news;
            const trend = data.industry_trend;
            const reddit = data.reddit_mentions;

            // Store ticker for chart updates
            window.currentTicker = info.symbol;
            window.currentPeriod = '1y';

            let html = '';

            // Basic Info Card
            html += `
                <div class="card">
                    <h2>${info.company_name} (${info.symbol})</h2>
                    <div class="info-grid">
                        <div class="metric-card">
                            <div class="label">Current Price</div>
                            <div class="value" style="color: #ffc107;">$${formatNumber(info.current_price)}</div>
                        </div>
                        <div class="metric-card">
                            <div class="label">Market Cap</div>
                            <div class="value">$${formatNumber(info.market_cap)}</div>
                        </div>
                        <div class="metric-card">
                            <div class="label">
                                <span class="tooltip-container">
                                    P/E Ratio
                                    <span class="tooltip-text">
                                        <strong>Price-to-Earnings Ratio</strong><br>
                                        Shows how much investors pay per dollar of earnings. 
                                        A high P/E may indicate overvaluation or high growth expectations. 
                                        A low P/E may suggest undervaluation or concerns about the company.
                                    </span>
                                </span>
                            </div>
                            <div class="value">${info.pe_ratio !== 'N/A' ? info.pe_ratio.toFixed(2) : 'N/A'}</div>
                        </div>
                        <div class="metric-card">
                            <div class="label">
                                <span class="tooltip-container">
                                    Beta
                                    <span class="tooltip-text">
                                        <strong>Beta (Volatility)</strong><br>
                                        Measures stock volatility vs. the market. 
                                        Beta > 1: More volatile than market<br>
                                        Beta = 1: Moves with market<br>
                                        Beta < 1: Less volatile than market<br>
                                        Negative Beta: Moves opposite to market
                                    </span>
                                </span>
                            </div>
                            <div class="value">${info.beta !== 'N/A' ? info.beta.toFixed(2) : 'N/A'}</div>
                        </div>
                    </div>
                    
                    <div class="info-grid" style="margin-top: 20px;">
                        <div class="info-item">
                            <label>Sector</label>
                            <div class="value">${info.sector}</div>
                        </div>
                        <div class="info-item">
                            <label>Industry</label>
                            <div class="value">${info.industry}</div>
                        </div>
                        <div class="info-item">
                            <label>52 Week High</label>
                            <div class="value">$${formatNumber(info['52_week_high'])}</div>
                        </div>
                        <div class="info-item">
                            <label>52 Week Low</label>
                            <div class="value">$${formatNumber(info['52_week_low'])}</div>
                        </div>
                    </div>
                </div>
            `;

            // Profitability Status Card
            const profitability = data.profitability;
            if (profitability && !profitability.error) {
                html += `
                    <div class="card">
                        <h2>üí∞ Profitability & Financial Health</h2>
                        
                        ${profitability.is_profitable !== undefined ? `
                        <div class="profitability-status ${profitability.is_profitable ? '' : 'unprofitable'}">
                            <h3 style="margin-top: 0; color: ${profitability.is_profitable ? '#10b981' : '#ef4444'};">
                                ${profitability.is_profitable ? '‚úÖ Company is PROFITABLE' : '‚ùå Company is LOSING Money'}
                            </h3>
                            ${profitability.profitable_years ? `
                            <p style="font-size: 1.1em; margin: 10px 0;">
                                Profitable for <strong>${profitability.profitable_years}</strong> years in recent history
                            </p>` : ''}
                            ${profitability.net_income ? `
                            <p style="font-size: 1em; color: #666;">
                                Latest Net Income: <strong style="color: ${profitability.net_income > 0 ? '#10b981' : '#ef4444'};">
                                $${formatNumber(profitability.net_income)}</strong>
                            </p>` : ''}
                        </div>
                        ` : ''}
                        
                        <div class="info-grid" style="margin-top: 20px;">
                            ${profitability.cash_reserves ? `
                            <div class="info-item">
                                <label>üíµ Cash Reserves (Backup Money)</label>
                                <div class="value">$${formatNumber(profitability.cash_reserves)}</div>
                            </div>` : ''}
                            ${profitability.total_debt ? `
                            <div class="info-item">
                                <label>üè¶ Total Debt</label>
                                <div class="value">$${formatNumber(profitability.total_debt)}</div>
                            </div>` : ''}
                            ${profitability.cash_to_debt_ratio ? `
                            <div class="info-item">
                                <label>Cash-to-Debt Ratio</label>
                                <div class="value ${profitability.cash_to_debt_ratio >= 1 ? 'positive' : 'negative'}">
                                    ${profitability.cash_to_debt_ratio}x
                                </div>
                                <small style="color: #666; display: block; margin-top: 5px;">
                                    ${profitability.cash_to_debt_ratio >= 1 ? 'Strong: Can cover all debt with cash' : 'Watch: Debt exceeds cash reserves'}
                                </small>
                            </div>` : ''}
                            ${profitability.operating_cash_flow ? `
                            <div class="info-item">
                                <label>üí∏ Operating Cash Flow</label>
                                <div class="value ${profitability.positive_cash_flow ? 'positive' : 'negative'}">
                                    $${formatNumber(profitability.operating_cash_flow)}
                                </div>
                                <small style="color: #666; display: block; margin-top: 5px;">
                                    ${profitability.positive_cash_flow ? 'Positive: Generating cash from operations' : 'Negative: Burning cash in operations'}
                                </small>
                            </div>` : ''}
                            ${profitability.free_cash_flow ? `
                            <div class="info-item">
                                <label>üîÑ Free Cash Flow</label>
                                <div class="value ${profitability.free_cash_flow > 0 ? 'positive' : 'negative'}">
                                    $${formatNumber(profitability.free_cash_flow)}
                                </div>
                            </div>` : ''}
                            ${profitability.current_ratio && profitability.current_ratio !== 'N/A' ? `
                            <div class="info-item">
                                <label>Current Ratio</label>
                                <div class="value ${profitability.current_ratio >= 1.5 ? 'positive' : 'negative'}">
                                    ${profitability.current_ratio.toFixed(2)}
                                </div>
                                <small style="color: #666; display: block; margin-top: 5px;">
                                    ${profitability.current_ratio >= 2 ? 'Excellent liquidity' : 
                                      profitability.current_ratio >= 1 ? 'Adequate liquidity' : 
                                      'Liquidity concerns'}
                                </small>
                            </div>` : ''}
                        </div>
                    </div>
                `;
            }

            // Industry Market Insights
            const insights = data.industry_insights;
            if (insights && insights.has_data) {
                html += `
                    <div class="card">
                        <h2>üåç Industry Market Outlook</h2>
                        <p style="color: #aaa; margin-bottom: 20px; font-size: 0.95em;">
                            Market analysis for ${insights.industry_name} industry ‚Ä¢ Data: ${insights.data_source}
                        </p>
                        
                        <div class="info-grid">
                            <div class="info-item" style="border-left-color: #28846b;">
                                <label>Market Size 2024</label>
                                <div class="value" style="color: #10b981; font-size: 1.8em;">
                                    $${insights.market_size_2024}B
                                </div>
                            </div>
                            <div class="info-item" style="border-left-color: #28846b;">
                                <label>Projected 2030</label>
                                <div class="value" style="color: #3b82f6; font-size: 1.8em;">
                                    $${insights.projected_2030}B
                                </div>
                            </div>
                            <div class="info-item" style="border-left-color: #28846b;">
                                <label>Growth Rate (CAGR)</label>
                                <div class="value positive" style="font-size: 1.8em;">
                                    ${insights.cagr}
                                </div>
                            </div>
                            <div class="info-item" style="border-left-color: #28846b;">
                                <label>Growth Multiplier</label>
                                <div class="value" style="font-size: 1.8em;">
                                    ${insights.growth_multiplier}x
                                </div>
                                <small style="color: #666; display: block; margin-top: 5px;">
                                    Market expected to grow ${insights.growth_multiplier}x by 2030
                                </small>
                            </div>
                        </div>
                        
                        ${insights.growth_drivers && insights.growth_drivers.length > 0 ? `
                        <h3 style="margin-top: 25px; color: #10b981;">üöÄ Key Growth Drivers</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 15px;">
                            ${insights.growth_drivers.map(driver => `
                                <div style="background: linear-gradient(135deg, #1f4a2f 0%, #142d1a 100%); 
                                            padding: 12px; border-radius: 8px; border-left: 3px solid #28846b;">
                                    <span style="font-size: 0.95em;">‚úì ${driver}</span>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                        
                        ${insights.key_trends && insights.key_trends.length > 0 ? `
                        <h3 style="margin-top: 25px; color: #3b82f6;">üìà Emerging Trends</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 15px;">
                            ${insights.key_trends.map(trend => `
                                <div style="background: linear-gradient(135deg, #1e3a5f 0%, #0f1e2e 100%); 
                                            padding: 12px; border-radius: 8px; border-left: 3px solid #3b82f6;">
                                    <span style="font-size: 0.95em;">‚Ä¢ ${trend}</span>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                        
                        ${insights.challenges && insights.challenges.length > 0 ? `
                        <h3 style="margin-top: 25px; color: #ef4444;">‚ö†Ô∏è Industry Challenges</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 15px;">
                            ${insights.challenges.map(challenge => `
                                <div style="background: linear-gradient(135deg, #4a1f1f 0%, #2d1414 100%); 
                                            padding: 12px; border-radius: 8px; border-left: 3px solid #ef4444;">
                                    <span style="font-size: 0.95em;">‚ö° ${challenge}</span>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                        
                        <div style="margin-top: 20px; padding: 12px; background: #2d2020; border-radius: 8px; font-size: 0.9em; color: #aaa;">
                            <strong>Context:</strong> Industry growth doesn't guarantee individual company success. 
                            Competitive positioning, execution, market share gains, and innovation determine whether this company 
                            captures its fair share of the expanding market. Compare with company-specific analyst targets and business outlook signals.
                        </div>
                    </div>
                `;
            }

            // Financial Metrics Card
            if (metrics && !metrics.error) {
                html += `
                    <div class="card">
                        <h2>üìä Financial Metrics</h2>
                        <div class="info-grid">
                            ${metrics.revenue ? `
                            <div class="info-item">
                                <label>Revenue (Latest)</label>
                                <div class="value">$${formatNumber(metrics.revenue)}</div>
                            </div>` : ''}
                            ${metrics.revenue_growth !== undefined ? `
                            <div class="info-item">
                                <label>Revenue Growth (YoY)</label>
                                <div class="value ${metrics.revenue_growth > 0 ? 'positive' : 'negative'}">
                                    ${metrics.revenue_growth > 0 ? '+' : ''}${metrics.revenue_growth}%
                                </div>
                            </div>` : ''}
                            ${metrics.gross_profit ? `
                            <div class="info-item">
                                <label>Gross Profit</label>
                                <div class="value">$${formatNumber(metrics.gross_profit)}</div>
                            </div>` : ''}
                            ${metrics.operating_income ? `
                            <div class="info-item">
                                <label>Operating Income</label>
                                <div class="value">$${formatNumber(metrics.operating_income)}</div>
                            </div>` : ''}
                            ${metrics.net_income ? `
                            <div class="info-item">
                                <label>Net Income</label>
                                <div class="value">$${formatNumber(metrics.net_income)}</div>
                            </div>` : ''}
                            ${metrics.ebitda ? `
                            <div class="info-item">
                                <label>EBITDA</label>
                                <div class="value">$${formatNumber(metrics.ebitda)}</div>
                            </div>` : ''}
                            ${metrics.ebit ? `
                            <div class="info-item">
                                <label>EBIT</label>
                                <div class="value">$${formatNumber(metrics.ebit)}</div>
                            </div>` : ''}
                        </div>
                        
                        ${data.price_history && data.price_history.prices && data.price_history.prices.length > 0 ? `
                        <h3>ÔøΩ Price History</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <button class="period-btn active" onclick="updateChart('1d')">1D</button>
                            <button class="period-btn" onclick="updateChart('5d')">5D</button>
                            <button class="period-btn" onclick="updateChart('1mo')">1M</button>
                            <button class="period-btn" onclick="updateChart('6mo')">6M</button>
                            <button class="period-btn" onclick="updateChart('1y')">1Y</button>
                            <button class="period-btn" onclick="updateChart('5y')">5Y</button>
                        </div>
                        <div class="financial-trend-chart" id="priceChart"></div>
                        ` : ''}
                        
                        <h3>Profitability Margins</h3>
                        <div class="info-grid">
                            ${metrics.gross_margin !== 'N/A' ? `
                            <div class="info-item">
                                <label>Gross Margin</label>
                                <div class="value">${formatPercent(metrics.gross_margin)}</div>
                            </div>` : ''}
                            ${metrics.operating_margin !== 'N/A' ? `
                            <div class="info-item">
                                <label>Operating Margin</label>
                                <div class="value">${formatPercent(metrics.operating_margin)}</div>
                            </div>` : ''}
                            ${metrics.profit_margin !== 'N/A' ? `
                            <div class="info-item">
                                <label>Profit Margin</label>
                                <div class="value">${formatPercent(metrics.profit_margin)}</div>
                            </div>` : ''}
                            ${metrics.return_on_equity !== 'N/A' ? `
                            <div class="info-item">
                                <label>Return on Equity</label>
                                <div class="value">${formatPercent(metrics.return_on_equity)}</div>
                            </div>` : ''}
                        </div>
                    </div>
                `;

                // Create price chart if price history data available
                if (data.price_history && data.price_history.prices && data.price_history.prices.length > 0) {
                    setTimeout(() => {
                        createPriceChart(data.price_history);
                    }, 100);
                }
                
                // Create analyst estimates chart if data available
                if (data.analyst_chart_data && data.analyst_chart_data.has_data && data.analyst_chart_data.dates) {
                    setTimeout(() => {
                        createAnalystChart(data.analyst_chart_data);
                    }, 150);
                }
            }

            // Industry Comparison
            if (comparison && !comparison.error) {
                html += `
                    <div class="card">
                        <h2>üè≠ Industry Comparison & P/E Analysis</h2>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Industry</label>
                                <div class="value">${comparison.industry}</div>
                            </div>
                            <div class="info-item">
                                <label>Sector</label>
                                <div class="value">${comparison.sector}</div>
                            </div>
                            <div class="info-item">
                                <label>Stock P/E Ratio</label>
                                <div class="value">${comparison.stock_pe !== 'N/A' ? (typeof comparison.stock_pe === 'number' ? comparison.stock_pe.toFixed(2) : comparison.stock_pe) : 'N/A'}
                                ${comparison.calculated_from_financials ? '<br><small style="color: #666;">(Calculated)</small>' : ''}</div>
                            </div>
                            ${comparison.industry_pe !== 'N/A' ? `
                            <div class="info-item">
                                <label>Industry P/E (Median)</label>
                                <div class="value">${typeof comparison.industry_pe === 'number' ? comparison.industry_pe.toFixed(2) : comparison.industry_pe}
                                ${comparison.peer_count ? `<br><small style="color: #666;">(${comparison.peer_count} peers)</small>` : ''}</div>
                            </div>` : ''}
                            ${comparison.industry_pe_mean !== 'N/A' && typeof comparison.industry_pe_mean === 'number' ? `
                            <div class="info-item">
                                <label>Industry P/E (Mean)</label>
                                <div class="value">${comparison.industry_pe_mean.toFixed(2)}</div>
                            </div>` : ''}
                        </div>
                        ${comparison.pe_vs_industry !== undefined ? `
                        <div style="margin-top: 20px; padding: 15px; background: #2d2020; border-radius: 10px; color: #f0f0f0;">
                            <strong>üìä P/E Analysis:</strong> This stock's P/E ratio is 
                            <span class="${comparison.pe_vs_industry > 0 ? 'negative' : 'positive'}" style="font-weight: bold; font-size: 1.1em;">
                                ${comparison.pe_vs_industry > 0 ? '+' : ''}${comparison.pe_vs_industry.toFixed(2)}%
                            </span>
                            ${comparison.pe_vs_industry > 0 ? 'higher' : 'lower'} than the industry median.
                            <br><br>
                            <span style="color: #ccc;">
                            ${comparison.pe_vs_industry > 20 ? 
                                '‚ö†Ô∏è <strong>Significantly overvalued</strong> compared to peers - high growth expectations or overpriced.' : 
                                comparison.pe_vs_industry > 0 ?
                                'üìà <strong>Moderately overvalued</strong> - market expects higher growth or stock may be expensive.' :
                                comparison.pe_vs_industry < -20 ?
                                'üí∞ <strong>Significantly undervalued</strong> - potential value opportunity or company faces challenges.' :
                                'üíµ <strong>Moderately undervalued</strong> - may represent good value or market concerns exist.'}
                            </span>
                        </div>
                        ` : comparison.industry_pe === 'N/A' ? `
                        <div style="margin-top: 20px; padding: 15px; background: #3d2a1a; border-radius: 10px; border-left: 4px solid #ffc107; color: #f0f0f0;">
                            <strong>‚ÑπÔ∏è Note:</strong> Industry P/E comparison not available. This could be because peer data is limited or the industry doesn't have sufficient comparable companies.
                        </div>
                        ` : ''}
                    </div>
                `;
            }

            // Industry Trend Analysis
            if (trend && !trend.error) {
                html += `
                    <div class="card">
                        <h2>üìà Analyst Consensus & Price Targets</h2>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Analyst Recommendation</label>
                                <div class="value" style="text-transform: uppercase;">${trend.recommendation}</div>
                            </div>
                            <div class="info-item">
                                <label>Current Price</label>
                                <div class="value" style="color: #ffc107;">$${formatNumber(trend.current_price)}</div>
                            </div>
                            <div class="info-item">
                                <label>Median Target Price</label>
                                <div class="value">$${formatNumber(trend.analyst_target)}</div>
                                <small style="color: #aaa; display: block; margin-top: 5px;">
                                    More robust than mean (less affected by outliers)
                                </small>
                            </div>
                            ${trend.num_analysts ? `
                            <div class="info-item">
                                <label>Number of Analysts</label>
                                <div class="value">${trend.num_analysts}</div>
                            </div>` : ''}
                        </div>
                        
                        ${trend.potential_upside !== undefined ? `
                        <div style="margin-top: 20px; padding: 15px; background: ${trend.potential_upside >= 0 ? '#1a3d2a' : '#3d1a1a'}; border-radius: 10px; border-left: 4px solid ${trend.potential_upside >= 0 ? '#10b981' : '#ef4444'}; color: #f0f0f0;">
                            <strong>Target-Based Upside Potential:</strong>
                            <span class="${trend.potential_upside > 0 ? 'positive' : 'negative'}" style="font-weight: bold; font-size: 1.2em; margin-left: 10px;">
                                ${trend.potential_upside > 0 ? '+' : ''}${trend.potential_upside.toFixed(2)}%
                            </span>
                            <br>
                            <small style="color: #ccc; margin-top: 5px; display: block;">
                                Based on median analyst target (${trend.num_analysts} analysts) vs. current price
                            </small>
                        </div>
                        ` : ''}
                        
                        ${trend.consensus_target ? `
                        <h3 style="margin-top: 25px;">üìä Analyst Consensus Analysis</h3>
                        <p style="color: #ccc; font-size: 0.95em; margin-bottom: 15px;">
                            Statistical analysis of current analyst price targets using probability distributions 
                            to assess consensus, upside potential, and risk-adjusted expectations.
                            ${trend.uses_historical_data ? `
                                <span style="color: #10b981; font-weight: 600;">
                                    ‚úì Enhanced with ${trend.historical_data_points || 'historical'} analyst estimates over ${trend.historical_date_range || '3 years'}
                                </span>
                            ` : `
                                <span style="color: #f59e0b;">
                                    ‚ö† Using current analyst data only
                                </span>
                            `}
                        </p>
                        
                        <div class="info-grid">
                            <div class="info-item" style="border-left-color: #10b981;">
                                <label>Consensus Target Price</label>
                                <div class="value">$${trend.consensus_target}</div>
                                <small style="color: #aaa; display: block; margin-top: 5px;">
                                    Median analyst target
                                </small>
                            </div>
                            <div class="info-item" style="border-left-color: #10b981;">
                                <label>Expected Return</label>
                                <div class="value ${trend.expected_return > 0 ? 'positive' : 'negative'}">
                                    ${trend.expected_return > 0 ? '+' : ''}${trend.expected_return}%
                                </div>
                                <small style="color: #aaa; display: block; margin-top: 5px;">
                                    Risk-adjusted expectation
                                </small>
                            </div>
                            <div class="info-item" style="border-left-color: #6b9bd1;">
                                <label>Probability of Upside</label>
                                <div class="value" style="color: ${trend.probability_upside >= 50 ? '#10b981' : '#ef4444'};">
                                    ${trend.probability_upside}%
                                </div>
                                <small style="color: #aaa; display: block; margin-top: 5px;">
                                    Chance target > current
                                </small>
                            </div>
                            <div class="info-item" style="border-left-color: #6b9bd1;">
                                <label>Consensus Strength</label>
                                <div class="value" style="font-size: 1em;">
                                    ${trend.analyst_consensus_strength}
                                </div>
                                <small style="color: #aaa; display: block; margin-top: 5px;">
                                    Agreement level
                                </small>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #2d2020; border-radius: 10px; border: 1px solid #3d2a2a;">
                            <h4 style="color: #f0f0f0; margin-top: 0;">üìä Confidence Intervals & Scenarios</h4>
                            <div class="info-grid">
                                <div class="info-item" style="border-left-color: #ffc107;">
                                    <label>90% Confidence Range</label>
                                    <div class="value" style="font-size: 1em; color: #f0f0f0;">
                                        $${trend.confidence_interval_90[0]} - $${trend.confidence_interval_90[1]}
                                    </div>
                                    <small style="color: #aaa; display: block; margin-top: 5px;">
                                        90% of estimates fall in this range
                                    </small>
                                </div>
                                <div class="info-item" style="border-left-color: #ffc107;">
                                    <label>50% Confidence Range (IQR)</label>
                                    <div class="value" style="font-size: 1em; color: #f0f0f0;">
                                        $${trend.confidence_interval_50[0]} - $${trend.confidence_interval_50[1]}
                                    </div>
                                    <small style="color: #aaa; display: block; margin-top: 5px;">
                                        Most likely price range
                                    </small>
                                </div>
                                ${trend.avg_upside_scenario ? `
                                <div class="info-item" style="border-left-color: #10b981;">
                                    <label>Average Bull Scenario</label>
                                    <div class="value positive">+${trend.avg_upside_scenario}%</div>
                                    <small style="color: #aaa; display: block; margin-top: 5px;">
                                        If target > current
                                    </small>
                                </div>` : ''}
                                ${trend.avg_downside_scenario ? `
                                <div class="info-item" style="border-left-color: #ef4444;">
                                    <label>Average Bear Scenario</label>
                                    <div class="value negative">${trend.avg_downside_scenario}%</div>
                                    <small style="color: #aaa; display: block; margin-top: 5px;">
                                        If target < current
                                    </small>
                                </div>` : ''}
                                ${trend.risk_reward_ratio ? `
                                <div class="info-item" style="border-left-color: #9333ea;">
                                    <label>Risk/Reward Ratio</label>
                                    <div class="value" style="color: ${trend.risk_reward_ratio > 2 ? '#10b981' : trend.risk_reward_ratio > 1 ? '#ffc107' : '#ef4444'};">
                                        ${trend.risk_reward_ratio}:1
                                    </div>
                                    <small style="color: #aaa; display: block; margin-top: 5px;">
                                        ${trend.risk_reward_ratio > 2 ? 'Excellent' : trend.risk_reward_ratio > 1 ? 'Favorable' : 'Unfavorable'}
                                    </small>
                                </div>` : ''}
                                <div class="info-item" style="border-left-color: #9333ea;">
                                    <label>Uncertainty (Std Dev)</label>
                                    <div class="value" style="font-size: 1em;">$${trend.consensus_std}</div>
                                    <small style="color: #aaa; display: block; margin-top: 5px;">
                                        Price volatility estimate
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 12px; background: #1a2a3a; border-radius: 8px; border-left: 3px solid #6b9bd1;">
                            <small style="color: #bbb;">
                                <strong>‚ÑπÔ∏è About Consensus Analysis:</strong> This analysis assumes analyst price targets follow 
                                a normal distribution to calculate probabilities and scenarios. The consensus target is the median 
                                of all analyst estimates, providing a balanced view of professional opinions. Confidence intervals 
                                show where the price is likely to fall based on the spread of analyst targets.
                            </small>
                        </div>
                        ` : ''}
                    </div>
                `;
            }

            // Analyst Estimates vs Actual Price Chart
            if (data.analyst_chart_data && data.analyst_chart_data.has_data && data.analyst_chart_data.dates) {
                const chartData = data.analyst_chart_data;
                html += `
                    <div class="card">
                        <h2>üìà Analyst Estimates vs Actual Price (${chartData.data_years} Years)</h2>
                        <p style="color: #ccc; font-size: 0.95em; margin-bottom: 10px;">
                            Historical stock price compared to 3 analyst estimate groups over time.
                            ${chartData.is_limited ? `<br><span style="color: #f59e0b;">‚ö†Ô∏è ${chartData.note}</span>` : `<span style="color: #10b981;">‚úì ${chartData.note}</span>`}
                        </p>
                        
                        <div class="info-grid" style="margin-bottom: 15px;">
                            <div class="info-item" style="border-left-color: #ef4444;">
                                <label>Group 1: Low Estimates (Bearish)</label>
                                <div class="value" style="font-size: 0.9em; color: #ef4444;">
                                    ${chartData.low_count} data points
                                </div>
                                <small style="color: #aaa;">Conservative/pessimistic forecasts</small>
                            </div>
                            <div class="info-item" style="border-left-color: #6b9bd1;">
                                <label>Group 2: Median Estimates (Neutral)</label>
                                <div class="value" style="font-size: 0.9em; color: #6b9bd1;">
                                    ${chartData.median_count} data points
                                </div>
                                <small style="color: #aaa;">Middle-ground forecasts</small>
                            </div>
                            <div class="info-item" style="border-left-color: #10b981;">
                                <label>Group 3: High Estimates (Bullish)</label>
                                <div class="value" style="font-size: 0.9em; color: #10b981;">
                                    ${chartData.high_count} data points
                                </div>
                                <small style="color: #aaa;">Optimistic forecasts</small>
                            </div>
                        </div>
                        
                        <div class="financial-trend-chart" id="analystChart"></div>
                        
                        <div style="margin-top: 15px; padding: 12px; background: #1a2a3a; border-radius: 8px; border-left: 3px solid #6b9bd1;">
                            <small style="color: #bbb;">
                                <strong>‚ÑπÔ∏è About the Estimate Groups:</strong> These groups show the current analyst target distribution: 
                                low estimates (conservative analysts), median estimates (consensus view), and high estimates (optimistic analysts). 
                                When available, historical estimates would show how these targets have evolved over time, providing insight into 
                                analyst confidence and price trend expectations.
                            </small>
                        </div>
                    </div>
                `;
            } else if (data.analyst_chart_data && data.analyst_chart_data.error) {
                html += `
                    <div class="card">
                        <h2>üìà Analyst Estimates vs Actual Price</h2>
                        <p style="color: #999;">No analyst estimate data available for this ticker.</p>
                    </div>
                `;
            }

            // Volume Analysis
            if (volumeData && !volumeData.error) {
                html += `
                    <div class="card">
                        <h2>üìä Trading Volume Analysis (Past Month)</h2>
                        
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="label">Average Volume:</span>
                                <span class="value">${volumeData.avg_volume.toLocaleString()}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Max Volume:</span>
                                <span class="value">${volumeData.max_volume.toLocaleString()}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Min Volume:</span>
                                <span class="value">${volumeData.min_volume.toLocaleString()}</span>
                            </div>
                        </div>
                        
                        ${volumeData.volume_spikes && volumeData.volume_spikes.length > 0 ? `
                        <h3 style="margin-top: 25px;">üî• Significant Volume Spikes (>50% above average)</h3>
                        ${volumeData.volume_spikes.map(spike => `
                            <div class="significant-move">
                                <strong>${spike.date}</strong>: 
                                <span style="font-weight: bold; color: #e67e22;">
                                    ${spike.volume.toLocaleString()} shares
                                </span>
                                <span style="color: #888; margin-left: 10px;">
                                    (+${spike.vs_avg}% vs avg)
                                </span>
                                <br>
                                <span style="font-size: 0.9em; color: #999; margin-left: 5px;">
                                    Price: $${spike.price} 
                                    <span class="${spike.price_change >= 0 ? 'positive' : 'negative'}">
                                        (${spike.price_change >= 0 ? '+' : ''}${spike.price_change}%)
                                    </span>
                                </span>
                            </div>
                        `).join('')}
                        ` : '<p style="margin-top:15px; color: #999;">No significant volume spikes detected in the past month.</p>'}
                    </div>
                `;
            }

            // Business Outlook
            const outlook = data.business_outlook;
            if (outlook && !outlook.error) {
                html += `
                    <div class="card">
                        <h2>üîÆ Business Potential & Outlook</h2>
                        <p style="color: #aaa; margin-bottom: 20px; font-size: 0.95em;">
                            Combined assessment of company-specific signals and industry market growth potential
                        </p>
                        
                        <div class="info-grid">
                            <div class="info-item" style="border-left-color: ${outlook.outlook_color};">
                                <span class="label">Overall Business Potential:</span>
                                <span class="value" style="color: ${outlook.outlook_color}; font-size: 1.8em;">
                                    ${outlook.outlook_label}
                                </span>
                                <div style="margin-top: 5px; font-size: 0.9em; color: #999;">
                                    Total Score: ${outlook.outlook_score}/100
                                </div>
                            </div>
                            <div class="info-item">
                                <span class="label">Company Signals:</span>
                                <span class="value">${outlook.company_score}/70</span>
                                <div style="margin-top: 5px; font-size: 0.85em; color: #888;">
                                    Strong: ${outlook.strong_signals} | Moderate: ${outlook.moderate_signals}
                                </div>
                            </div>
                            <div class="info-item">
                                <span class="label">Industry Growth Bonus:</span>
                                <span class="value ${outlook.industry_bonus > 15 ? 'positive' : ''}">+${outlook.industry_bonus}/30</span>
                                <div style="margin-top: 5px; font-size: 0.85em; color: #888;">
                                    ${outlook.has_industry_data ? 'Market growth factored in' : 'No industry data available'}
                                </div>
                            </div>
                        </div>
                        
                        ${outlook.industry_context ? `
                        <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #1f4a2f 0%, #142d1a 100%); 
                                    border-radius: 8px; border-left: 4px solid #28846b;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5em;">üåä</span>
                                <div>
                                    <strong style="color: #10b981; font-size: 1.05em;">Industry Tailwind</strong>
                                    <p style="margin: 5px 0 0 0; color: #e0e0e0; font-size: 0.95em;">
                                        ${outlook.industry_context}
                                    </p>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="info-grid" style="margin-top: 20px;">
                            <div class="info-item">
                                <span class="label">Strong Signals:</span>
                                <span class="value">${outlook.strong_signals}</span>
                                <div style="margin-top: 5px; font-size: 0.85em; color: #888;">
                                    (sold out, fully booked, etc.)
                                </div>
                            </div>
                            <div class="info-item">
                                <span class="label">Moderate Signals:</span>
                                <span class="value">${outlook.moderate_signals}</span>
                                <div style="margin-top: 5px; font-size: 0.85em; color: #888;">
                                    (strong bookings, raised guidance, etc.)
                                </div>
                            </div>
                        </div>
                        
                        ${outlook.evidence && outlook.evidence.length > 0 ? `
                        <h3 style="margin-top: 25px; color: #e0e0e0;">üìã Evidence from News</h3>
                        ${outlook.evidence.map(ev => `
                            <div class="news-item" style="border-left-color: ${ev.strength === 'strong' ? '#10b981' : '#f59e0b'};">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <h4 style="flex: 1;">${ev.title}</h4>
                                    <span style="background: ${ev.strength === 'strong' ? '#10b981' : '#f59e0b'}; 
                                                 color: white; padding: 3px 8px; border-radius: 5px; 
                                                 font-size: 0.75em; font-weight: bold; text-transform: uppercase;">
                                        ${ev.strength}
                                    </span>
                                </div>
                                <div class="meta" style="margin-top: 8px;">
                                    Keyword: "${ev.keyword}" ‚Ä¢ ${ev.date}
                                </div>
                                ${ev.link ? `<a href="${ev.link}" target="_blank">Read article ‚Üí</a>` : ''}
                            </div>
                        `).join('')}
                        ` : '<p style="margin-top:15px; color: #999;">No strong booking/demand signals detected in recent news.</p>'}
                        
                        <div style="margin-top: 20px; padding: 12px; background: #2d2020; border-radius: 8px; font-size: 0.9em; color: #aaa;">
                            <strong>How to interpret:</strong> This combines company-specific demand signals (70 max points) 
                            with industry market growth momentum (30 max points). A high score suggests both strong immediate business 
                            activity AND favorable long-term market trends. Compare with analyst targets to see if the market has priced in this potential.
                        </div>
                    </div>
                `;
            }

            // News
                                    </span>
                                </div>
                                <div class="meta" style="margin-top: 8px;">
                                    Keyword: "${ev.keyword}" ‚Ä¢ ${ev.date}
                                </div>
                                ${ev.link ? `<a href="${ev.link}" target="_blank">Read article ‚Üí</a>` : ''}
                            </div>
                        `).join('')}
                        ` : '<p style="margin-top:15px; color: #999;">No strong booking/demand signals detected in recent news.</p>'}
                        
                        <div style="margin-top: 20px; padding: 12px; background: #2d2020; border-radius: 8px; font-size: 0.9em; color: #aaa;">
                            <strong>Note:</strong> This analysis is based on keyword matching in recent news. 
                            A high score suggests positive business momentum, but doesn't indicate whether the market has already priced it in. 
                            Compare with the analyst consensus to gauge market expectations.
                        </div>
                    </div>
                `;
            }

            // News
            if (news && Array.isArray(news) && news.length > 0) {
                const visibleNews = news.slice(0, 3);
                const hiddenNews = news.slice(3);
                
                html += `
                    <div class="card">
                        <h2>üì∞ Latest News</h2>
                        <div id="visibleNews">
                            ${visibleNews.map(item => `
                                <div class="news-item">
                                    <h4>${item.title}</h4>
                                    ${item.summary ? `<p style="color: #666; margin: 8px 0; font-size: 0.95em;">${item.summary}</p>` : ''}
                                    <div class="meta">
                                        ${item.publisher} ‚Ä¢ ${item.publish_time}
                                    </div>
                                    ${item.link ? `<a href="${item.link}" target="_blank">Read full article ‚Üí</a>` : ''}
                                </div>
                            `).join('')}
                        </div>
                        ${hiddenNews.length > 0 ? `
                        <div id="hiddenNews" style="display: none;">
                            ${hiddenNews.map(item => `
                                <div class="news-item">
                                    <h4>${item.title}</h4>
                                    ${item.summary ? `<p style="color: #666; margin: 8px 0; font-size: 0.95em;">${item.summary}</p>` : ''}
                                    <div class="meta">
                                        ${item.publisher} ‚Ä¢ ${item.publish_time}
                                    </div>
                                    ${item.link ? `<a href="${item.link}" target="_blank">Read full article ‚Üí</a>` : ''}
                                </div>
                            `).join('')}
                        </div>
                        <button id="showMoreNewsBtn" onclick="toggleNews()" style="
                            margin-top: 15px;
                            padding: 10px 20px;
                            background: linear-gradient(135deg, #1f4a2f 0%, #28846b 100%);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            transition: all 0.3s;
                        ">
                            Show ${hiddenNews.length} More News ‚Üí
                        </button>
                        ` : ''}
                    </div>
                `;
            } else {
                html += `
                    <div class="card">
                        <h2>üì∞ Latest News</h2>
                        <p style="color: #999;">No recent news available for this stock.</p>
                    </div>
                `;
            }

            // Reddit Mentions
            if (reddit && Array.isArray(reddit) && reddit.length > 0) {
                html += `
                    <div class="card">
                        <h2>üí¨ Reddit Discussions</h2>
                        <p style="color: #aaa; margin-bottom: 15px; font-size: 0.9em;">
                            Filtered for quality discussions from reliable subreddits. Spam and low-effort posts removed.
                        </p>
                        ${reddit.map(item => `
                            <div class="reddit-item" style="border-left-color: ${item.tier === 1 ? '#10b981' : '#f59e0b'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div style="flex: 1;">
                                        <span class="score" style="background: ${item.tier === 1 ? '#10b981' : '#f59e0b'};">‚Üë ${item.score}</span>
                                        <strong style="margin-left: 10px;">${item.title}</strong>
                                    </div>
                                    <span style="background: ${item.tier === 1 ? 'rgba(16, 185, 129, 0.2)' : 'rgba(245, 158, 11, 0.2)'}; 
                                                 color: ${item.tier === 1 ? '#10b981' : '#f59e0b'}; 
                                                 padding: 3px 8px; border-radius: 5px; 
                                                 font-size: 0.75em; font-weight: bold; white-space: nowrap;">
                                        r/${item.subreddit}
                                    </span>
                                </div>
                                <div class="meta" style="margin-top: 5px;">
                                    üí¨ ${item.num_comments} comments ‚Ä¢ üìÖ ${item.created} ‚Ä¢ Quality: ${Math.round(item.quality_score)}
                                    <br><a href="${item.url}" target="_blank">View discussion ‚Üí</a>
                                </div>
                            </div>
                        `).join('')}
                        <div style="margin-top: 15px; padding: 10px; background: #202d25; border-radius: 8px; font-size: 0.85em; color: #999;">
                            <strong>Quality Tiers:</strong> 
                            <span style="color: #10b981;">‚óè</span> Tier 1: Fundamental analysis (r/investing, r/stocks, r/ValueInvesting) ‚Ä¢ 
                            <span style="color: #f59e0b;">‚óè</span> Tier 2: Active trading (r/wallstreetbets, r/options)
                        </div>
                    </div>
                `;
            } else if (reddit && reddit.info) {
                html += `
                    <div class="card">
                        <h2>üí¨ Reddit Discussions</h2>
                        <p style="color: #999;">${reddit.info}</p>
                        <p style="margin-top: 10px; font-size: 0.9em; color: #aaa;">
                            ${reddit.info.includes('not configured') ? 
                                'To enable Reddit integration, create a Reddit app at <a href="https://www.reddit.com/prefs/apps" target="_blank" style="color: #ff9999;">reddit.com/prefs/apps</a> and add your credentials to a .env file.' 
                                : 'Try searching for more popular tickers like AAPL, TSLA, NVDA, etc.'}
                        </p>
                    </div>
                `;
            }

            results.innerHTML = html;
        }

        function createPriceChart(priceData) {
            if (!priceData || !priceData.prices || priceData.prices.length === 0) {
                return;
            }

            const firstPrice = priceData.prices[0];
            const percentChanges = priceData.prices.map(price => 
                ((price - firstPrice) / firstPrice * 100).toFixed(2)
            );

            const customdata = priceData.prices.map((price, i) => ({
                price: price,
                percentChange: percentChanges[i]
            }));

            const trace = {
                x: priceData.dates,
                y: priceData.prices,
                customdata: customdata,
                type: 'scatter',
                mode: 'lines',
                name: 'Price',
                line: {
                    color: '#28846b',
                    width: 2
                },
                hovertemplate: 
                    '<b>Date:</b> %{x}<br>' +
                    '<b>Price:</b> $%{y:.2f}<br>' +
                    '<b>Change from start:</b> %{customdata.percentChange}%<br>' +
                    '<extra></extra>'
            };

            const layout = {
                title: {
                    text: `Stock Price - ${window.currentPeriod.toUpperCase()}`,
                    font: { color: '#f0f0f0' }
                },
                xaxis: { 
                    title: 'Date',
                    gridcolor: '#2d2d2d',
                    color: '#f0f0f0'
                },
                yaxis: { 
                    title: 'Price (USD)',
                    gridcolor: '#2d2d2d',
                    color: '#f0f0f0'
                },
                plot_bgcolor: '#020a05',
                paper_bgcolor: '#1a1515',
                font: { color: '#f0f0f0' },
                hovermode: 'closest',
                hoverlabel: {
                    bgcolor: '#1a3d2a',
                    bordercolor: '#28846b',
                    font: { size: 13, color: '#f0f0f0' }
                }
            };

            Plotly.newPlot('priceChart', [trace], layout, {responsive: true});
        }

        function createAnalystChart(data) {
            if (!data || !data.dates || data.dates.length === 0) {
                return;
            }

            const traces = [
                {
                    x: data.dates,
                    y: data.actual_price,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Actual Stock Price',
                    line: { color: '#28846b', width: 3 },
                    marker: { size: 4, color: '#28846b' },
                    hovertemplate: '<b>Actual Price:</b> $%{y:.2f}<extra></extra>'
                },
                {
                    x: data.dates,
                    y: data.low_estimates,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Group 1: Low Estimates (Bearish)',
                    line: { color: '#ef4444', width: 2, dash: 'dot' },
                    marker: { size: 3, color: '#ef4444' },
                    hovertemplate: '<b>Low Estimate:</b> $%{y:.2f}<extra></extra>'
                },
                {
                    x: data.dates,
                    y: data.median_estimates,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Group 2: Median Estimates (Neutral)',
                    line: { color: '#6b9bd1', width: 2, dash: 'solid' },
                    marker: { size: 3, color: '#6b9bd1' },
                    hovertemplate: '<b>Median Estimate:</b> $%{y:.2f}<extra></extra>'
                },
                {
                    x: data.dates,
                    y: data.high_estimates,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Group 3: High Estimates (Bullish)',
                    line: { color: '#10b981', width: 2, dash: 'dash' },
                    marker: { size: 3, color: '#10b981' },
                    hovertemplate: '<b>High Estimate:</b> $%{y:.2f}<extra></extra>'
                }
            ];

            const layout = {
                title: {
                    text: `Analyst Estimate Groups vs Actual Price (${data.data_years} Years)`,
                    font: { color: '#f0f0f0', size: 16 }
                },
                xaxis: { 
                    title: 'Date (Time)',
                    gridcolor: '#2d2d2d',
                    color: '#f0f0f0'
                },
                yaxis: { 
                    title: 'Stock Price (USD)',
                    gridcolor: '#2d2d2d',
                    color: '#f0f0f0'
                },
                plot_bgcolor: '#020a05',
                paper_bgcolor: '#1a1515',
                font: { color: '#f0f0f0' },
                hovermode: 'x unified',
                legend: {
                    font: { color: '#f0f0f0', size: 11 },
                    bgcolor: 'rgba(26, 21, 21, 0.8)',
                    orientation: 'v',
                    x: 1.02,
                    y: 1
                },
                hoverlabel: {
                    bgcolor: '#1a3d2a',
                    font: { color: '#f0f0f0' }
                },
                showlegend: true
            };

            Plotly.newPlot('analystChart', traces, layout, {responsive: true});
        }


        async function updateChart(period) {
            if (!window.currentTicker) return;
            
            // Update button states
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            window.currentPeriod = period;
            
            try {
                const response = await fetch(`/chart/${window.currentTicker}?period=${period}`);
                const data = await response.json();
                
                if (data.error) {
                    console.error('Chart error:', data.error);
                    return;
                }
                
                createPriceChart(data);
            } catch (error) {
                console.error('Error updating chart:', error);
            }
        }

        function toggleNews() {
            const hiddenNews = document.getElementById('hiddenNews');
            const btn = document.getElementById('showMoreNewsBtn');
            
            if (hiddenNews.style.display === 'none') {
                hiddenNews.style.display = 'block';
                btn.textContent = 'Show Less News ‚Üë';
            } else {
                hiddenNews.style.display = 'none';
                const count = hiddenNews.querySelectorAll('.news-item').length;
                btn.textContent = `Show ${count} More News ‚Üí`;
            }
        }
    </script>
</body>
</html>
